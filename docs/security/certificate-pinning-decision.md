# 証明書ピニング実装の判断

**作成日**: 2025年1月
**最終更新**: 2025年1月

## 判断結果

**現時点での判断: 実装を見送る（オプションとして準備）**

## プロジェクトの性質

### アプリケーション概要
- **種類**: 個人利用向けのバーコードリーダーアプリ
- **主要機能**: 書籍バーコードスキャン、Notion API連携、OpenBD API連携
- **機密情報**: Notion Integration Token（端末内に暗号化保存）
- **プラットフォーム**: iOS/Android（React Native）
- **ユーザー規模**: 個人利用（小規模）

### 既存のセキュリティ対策
- ✅ iOS App Transport Security (ATS) 設定済み
- ✅ HTTPS通信の強制
- ✅ 機密情報の暗号化（MMKV + AES-256-GCM）
- ✅ ログマスキング機能
- ✅ 入力値検証・サニタイゼーション
- ✅ CSRF対策

## 証明書ピニングのメリット

### 1. セキュリティ強化
- **中間者攻撃（MITM）の防止**: 悪意のある証明書による攻撃を防ぐ
- **証明書機関（CA）の侵害に対する保護**: CAが侵害されても影響を受けにくい
- **企業ネットワークでの保護**: 企業プロキシによる証明書インジェクションを防ぐ

### 2. セキュリティ標準への準拠
- OWASP Mobile Top 10で推奨される対策
- 金融アプリや企業アプリで一般的に採用
- セキュリティ監査で評価される項目

### 3. ユーザー信頼の向上
- セキュリティ意識の高いユーザーへのアピール
- プライバシー重視のユーザーへの訴求

## 証明書ピニングのデメリット

### 1. 実装・メンテナンスコスト
- **証明書の取得とハッシュ生成**: 初期設定に時間がかかる（約8-13時間）
- **証明書更新時の対応**: 証明書が更新されるとアプリ更新が必要（通常1年ごと、年1-2回、2-4時間/回）
- **緊急対応の必要性**: 証明書更新時にアプリが動作しなくなるリスク
- **複数証明書の管理**: 証明書チェーン（中間証明書）も含めて管理が必要

### 2. 技術的リスク
- **証明書更新の見逃し**: 証明書が更新されたことに気づかず、アプリが動作しなくなる
- **ライブラリの互換性**: `react-native-ssl-pinning`のメンテナンス状況やAPI変更のリスク
- **プラットフォーム固有の問題**: iOS/Androidで異なる動作やバグの可能性

### 3. 開発体験への影響
- **開発環境での複雑さ**: 開発時に証明書ピニングを無効化する必要がある
- **デバッグの困難さ**: 証明書関連のエラーの原因特定が難しい
- **テスト環境の構築**: テスト用の証明書設定が必要

### 4. 実装の複雑さ
- **react-native-ssl-pinningのAPI**: 現在の実装は仮実装で、実際のAPI仕様に合わせて調整が必要
- **エラーハンドリング**: 証明書ピニング失敗時の適切な処理が必要
- **フォールバック処理**: 証明書ピニング失敗時の動作を慎重に設計する必要がある

## リスク評価

### このアプリでのリスクレベル

#### 低リスク要因
1. **個人利用アプリ**: 大規模な攻撃対象になりにくい
2. **既存のセキュリティ対策**: ATS設定とHTTPS強制で基本的な保護は確保
3. **機密情報の扱い**: Notion Tokenは端末内に暗号化保存（ネットワーク経由で送信されない）
4. **APIの信頼性**: Notion API、OpenBD APIは信頼できるサービス

#### 中リスク要因
1. **企業ネットワーク環境**: 企業プロキシによる証明書インジェクションの可能性
2. **公共Wi-Fi**: 悪意のあるWi-Fiアクセスポイントの可能性
3. **ユーザーのセキュリティ意識**: セキュリティ意識の高いユーザーへの訴求

## 実装コスト分析

### 初期実装コスト
- **証明書取得スクリプト**: 2-3時間
- **設定ファイル作成**: 1時間
- **実装の調整**: 2-4時間（react-native-ssl-pinningのAPI仕様確認含む）
- **テスト実装**: 2-3時間
- **ドキュメント作成**: 1-2時間
- **合計**: 約8-13時間

### 継続的メンテナンスコスト
- **証明書更新の監視**: 月1回の確認（自動化可能）
- **証明書更新時の対応**: 年1-2回、2-4時間/回
- **ライブラリの更新**: 依存関係の更新時に確認、1-2時間/回
- **年間コスト**: 約10-20時間

## 判断理由

### 1. コスト対効果が低い
- 個人利用アプリでは、証明書ピニングのメリットが限定的
- 既存のセキュリティ対策（ATS、HTTPS強制）で基本的な保護は確保されている
- 実装・メンテナンスコストに対して、得られるセキュリティ向上が小さい

### 2. リスクが低い
- 個人利用アプリで大規模な攻撃対象になりにくい
- Notion Tokenは端末内に暗号化保存され、ネットワーク経由で送信されない
- 信頼できるAPIサービスを使用

### 3. メンテナンス負担
- 証明書更新時の緊急対応が必要
- 小規模プロジェクトでは継続的な監視が困難な可能性

## 実装を検討すべき条件

以下の条件が満たされる場合は実装を検討：

1. **ユーザー規模の拡大**: 企業利用や大規模ユーザーベースへの展開
2. **セキュリティ要件の強化**: 金融機関や医療機関での利用
3. **セキュリティ監査の要求**: 外部監査で証明書ピニングが要求される
4. **競合アプリとの差別化**: セキュリティを主要な訴求ポイントとする場合

## 代替案: 段階的実装

### Phase 1（現時点）: 実装を見送り、骨組みのみ維持
- 現在の実装（`src/utils/certificatePinning.ts`）を維持
- 証明書ハッシュは設定しない（空の配列のまま）
- 本番環境でも証明書ピニングは無効化されたまま（証明書ハッシュが設定されていないため）

### Phase 2（将来）: 条件が整ったら実装
- 証明書取得スクリプトの作成
- 証明書ハッシュの設定
- 本番環境での有効化

## 現在の実装状態

### 実装済み
- `src/utils/certificatePinning.ts`: 証明書ピニングの骨組み実装
- `src/utils/apiClient.ts`: 本番環境での証明書ピニング統合準備
- `react-native-ssl-pinning`: ライブラリインストール済み

### 未実装
- 証明書ハッシュの設定（空の配列のまま）
- 証明書取得スクリプト
- 証明書検証機能

### 動作
- 現在は証明書ハッシュが設定されていないため、証明書ピニングは実質的に無効化されている
- 本番環境でも通常のHTTPS通信が使用される（ATS設定による保護あり）

## 監視体制

以下の条件を監視し、実装条件が整ったら再検討：

1. **ユーザー規模**: 企業利用や大規模ユーザーベースへの展開
2. **セキュリティ要件**: 外部監査や規制要件の変化
3. **競合状況**: 競合アプリのセキュリティ対策の動向
4. **インシデント**: 証明書関連のセキュリティインシデントの発生

## 参考資料

- [OWASP Certificate Pinning](https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning)
- [Apple App Transport Security](https://developer.apple.com/documentation/security/preventing_insecure_network_connections)
- [React Native Security Best Practices](https://reactnative.dev/docs/security)
- [証明書ピニング実装計画](./certificate-pinning-implementation-plan.md)（将来の実装時に参照）

