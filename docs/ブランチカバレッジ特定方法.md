# ブランチカバレッジ特定方法

## 1. カバレッジレポートの確認

### 基本的な方法
```bash
npm test -- --coverage
```

このコマンドで、各ファイルのカバレッジが表示されます：
- `% Stmts`: ステートメントカバレッジ
- `% Branch`: **ブランチカバレッジ**（if文、三項演算子、論理演算子などの分岐）
- `% Funcs`: 関数カバレッジ
- `% Lines`: 行カバレッジ

### ブランチカバレッジが低いファイルを特定
```bash
npm test -- --coverage 2>&1 | grep -A 200 "File.*% Stmts" | grep -E "^\s+[^|].*\|" | grep -v "All files\|File\|---" | awk -F'|' '{if ($3+0 < 80) print $1 " | " $2 " | " $3 " | " $4 " | " $5}'
```

## 2. HTMLレポートで詳細確認

### HTMLレポートの生成
```bash
npm test -- --coverage --coverageReporters=html
```

その後、`coverage/lcov-report/index.html`をブラウザで開きます。

HTMLレポートでは：
- 各ファイルをクリックして詳細を確認
- 未カバーの行が赤色で表示される
- ブランチ（if文など）の未カバー部分がハイライトされる

## 3. 特定のファイルの未カバー行を確認

```bash
npm test -- --coverage 2>&1 | grep -A 5 "ファイル名"
```

例：
```bash
npm test -- --coverage 2>&1 | grep -A 5 "errorHandler.ts"
```

## 4. ブランチカバレッジが低い原因

ブランチカバレッジが低い主な原因：

1. **if文のelse節が実行されていない**
   ```typescript
   if (condition) {
     // テストされている
   } else {
     // テストされていない ← これが原因
   }
   ```

2. **三項演算子の片方の分岐が実行されていない**
   ```typescript
   const value = condition ? value1 : value2;
   // value1またはvalue2の片方しかテストされていない
   ```

3. **論理演算子の短絡評価**
   ```typescript
   if (obj && obj.property) {
     // objがnullの場合の分岐がテストされていない
   }
   ```

4. **switch文のcaseが実行されていない**
   ```typescript
   switch (value) {
     case 'A': // テストされている
       break;
     case 'B': // テストされていない ← これが原因
       break;
   }
   ```

## 5. ブランチカバレッジを向上させる方法

### テストケースの追加

1. **if文の両方の分岐をテスト**
   ```typescript
   // テスト1: conditionがtrueの場合
   it('conditionがtrueの場合は処理Aを実行する', () => {
     // ...
   });

   // テスト2: conditionがfalseの場合
   it('conditionがfalseの場合は処理Bを実行する', () => {
     // ...
   });
   ```

2. **エラーケースのテスト**
   ```typescript
   // 成功ケース
   it('正常に処理が完了する', async () => {
     // ...
   });

   // エラーケース
   it('エラー発生時はエラーメッセージを返す', async () => {
     // ...
   });
   ```

3. **null/undefinedのテスト**
   ```typescript
   // 値が存在する場合
   it('値が存在する場合は処理を実行する', () => {
     // ...
   });

   // 値がnullの場合
   it('値がnullの場合はデフォルト値を返す', () => {
     // ...
   });
   ```

## 6. 実際の例

### 例1: errorHandler.ts
ブランチカバレッジが56.52%の場合：
- `ErrorUtils`が存在する場合と存在しない場合の両方をテスト
- `defaultErrorHandler`が存在する場合とnullの場合の両方をテスト
- `global.ErrorUtils`が存在する場合と存在しない場合の両方をテスト

### 例2: NotionRepository.ts
ブランチカバレッジが75.4%の場合：
- `buildPropertiesFromConfig`で`item.isBook()`がtrueの場合とfalseの場合の両方をテスト
- `config.propertyMapping.isbn`が存在する場合と存在しない場合の両方をテスト
- `response.results`がnullの場合のテストを追加

## 7. カバレッジ目標

- **Statements**: 80%以上
- **Branches**: 80%以上 ← **これが最も重要**
- **Functions**: 80%以上
- **Lines**: 80%以上

ブランチカバレッジは、コードの分岐（if文、三項演算子など）がどれだけテストされているかを示します。
80%以上を目指すことで、エッジケースも適切にテストされていることを確認できます。

