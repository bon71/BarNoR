# スキャンUX完全修正実装指示書

## 📋 問題の詳細

### 問題1: 「スキャン結果がありません」が2秒表示される

**現象**:
- ISBNをスキャン成功後、「スキャン結果がありません」というカードが2秒ほど表示される
- その後、スキャン結果画面に遷移する
- 成功しているのにネガティブなメッセージが表示され、UXが悪い

**根本原因** (ScanScreen.tsx:66-94):
```typescript
const handleBarcodeScanned = useCallback(async (barcode: string) => {
  setShowScanner(false); // ❌ ここで即座にスキャナーを非表示

  try {
    const result = await scanViewModel.scanBarcode(barcode);

    if (result.success && result.item) {
      Vibration.vibrate(200);
      setShowSuccessMessage(true);

      setTimeout(() => {
        setShowSuccessMessage(false);
        onClose();
        navigation.navigate('ScanResult', {item: result.item});
      }, 1500);
    }
  } catch (err) {
    console.error('Unexpected error during barcode scan:', err);
    showErrorToast('バーコードのスキャン中にエラーが発生しました');
    setShowScanner(true);
  }
}, [navigation, onClose]);
```

**問題の流れ**:
1. `setShowScanner(false)` で即座にスキャナーを非表示
2. `showScanner === false` になり、elseブロックに入る (line 140-219)
3. `isLoading === false` かつ `error === null` の場合、「スキャン結果がありません」が表示される (line 198-215)
4. データ取得完了後、1.5秒待機してから遷移

### 問題2: スキャン結果画面の書影コンテナが白背景

**現象**:
- ダークモードでも書影コンテナの背景が明るいグレー (#F5F5F5) で表示される
- 周囲がダークなのに書影部分だけ白っぽく浮いて見える

**根本原因** (ScanResultScreen.tsx:321-327):
```typescript
imageContainer: {
  alignItems: 'center',
  marginBottom: spacing.lg,
  backgroundColor: '#F5F5F5', // ❌ ハードコードされた明るい背景色
  borderRadius: 8,
  padding: spacing.md,
},
```

## 🎯 解決方針

### 問題1の解決方針
以前作成した `docs/20250118_スキャン成功時UX改善.md` の内容を実装する：

1. **スキャナー画面を維持**: `setShowScanner(false)` を削除し、処理中もスキャナー画面を表示
2. **処理中フラグの導入**: `isProcessing` ステートで処理中を管理
3. **条件付きローディング表示**: 500ms以上かかる場合のみ「データ取得中...」を表示
4. **待機時間の短縮**: 1.5秒 → 0.5秒
5. **不要な画面の削除**: 「スキャン結果がありません」のelseブロックを `null` に変更

### 問題2の解決方針
テーマカラーを使用して背景色を動的に設定：

1. **ハードコードされた色を削除**: `#F5F5F5` を削除
2. **テーマカラーを使用**: `colors.card` または `colors.surface` を使用
3. **ダークモード対応**: テーマシステムに従った背景色

## 📝 実装内容

### 修正1: ScanScreen.tsx の完全修正

**ファイルパス**: `src/presentation/screens/ScanScreen.tsx`

#### ステップ1: 状態管理の追加

**現在のコード (line 42-49)**:
```typescript
const [showScanner, setShowScanner] = useState(true);
const [showSuccessMessage, setShowSuccessMessage] = useState(false);
const isLoading = useScanStore(state => state.isLoading);
const error = useScanStore(state => state.error);
const {config} = useConfigStore();
const [configError, setConfigError] = useState<string | null>(null);
```

**修正後**:
```typescript
const [showScanner, setShowScanner] = useState(true);
const [showSuccessMessage, setShowSuccessMessage] = useState(false);
const [isProcessing, setIsProcessing] = useState(false); // ✅ 追加
const [showLoadingMessage, setShowLoadingMessage] = useState(false); // ✅ 追加
const isLoading = useScanStore(state => state.isLoading);
const error = useScanStore(state => state.error);
const {config} = useConfigStore();
const [configError, setConfigError] = useState<string | null>(null);
```

#### ステップ2: handleBarcodeScanned の完全書き換え

**現在のコード (line 66-94)** を以下に置き換え:

```typescript
const handleBarcodeScanned = useCallback(async (barcode: string) => {
  // ✅ スキャナーは表示したまま、処理中フラグを立てる
  setIsProcessing(true);

  // ✅ 500ms後もデータ取得が完了していなければローディングメッセージ表示
  const loadingTimer = setTimeout(() => {
    setShowLoadingMessage(true);
  }, 500);

  try {
    // ViewModelを使ってバーコード情報を取得
    const result = await scanViewModel.scanBarcode(barcode);

    // タイマーをクリア
    clearTimeout(loadingTimer);
    setShowLoadingMessage(false);

    if (result.success && result.item) {
      // スキャン成功時のフィードバック
      Vibration.vibrate(200);

      // 成功メッセージを表示
      setShowSuccessMessage(true);

      // ✅ 500ms後に結果画面に遷移（1.5秒→0.5秒に短縮）
      setTimeout(() => {
        setShowSuccessMessage(false);
        setIsProcessing(false);
        onClose(); // モーダルを閉じる
        navigation.navigate('ScanResult', {item: result.item});
      }, 500);
    } else {
      // エラーの場合
      setIsProcessing(false);
      setShowScanner(false); // エラー時のみスキャナーを非表示
    }
  } catch (err) {
    // 予期しないエラー
    clearTimeout(loadingTimer);
    setShowLoadingMessage(false);
    setIsProcessing(false);
    console.error('Unexpected error during barcode scan:', err);
    showErrorToast('バーコードのスキャン中にエラーが発生しました');
    setShowScanner(true);
  }
}, [navigation, onClose]);
```

#### ステップ3: BarcodeScanner コンポーネントの enabled 修正

**現在のコード (line 143-147)**:
```typescript
<BarcodeScanner
  enabled={!configError}
  onBarcodeScanned={handleBarcodeScanned}
  onClose={handleClose}
/>
```

**修正後**:
```typescript
<BarcodeScanner
  enabled={!configError && !isProcessing} // ✅ 処理中はスキャン無効化
  onBarcodeScanned={handleBarcodeScanned}
  onClose={handleClose}
/>
```

#### ステップ4: ローディングメッセージUIの追加

**現在のコード (line 149-156)** の直後に追加:

```typescript
{/* スキャン成功メッセージ */}
{showSuccessMessage && (
  <View style={styles.successMessageContainer}>
    <View style={styles.successMessageBox}>
      <Text style={styles.successMessageText}>✅ Scan Succeed</Text>
    </View>
  </View>
)}

{/* ✅ データ取得中メッセージ（500ms以上かかる場合のみ表示） */}
{showLoadingMessage && (
  <View style={styles.loadingMessageContainer}>
    <View style={styles.loadingMessageBox}>
      <Text style={styles.loadingMessageText}>📚 データ取得中...</Text>
    </View>
  </View>
)}
```

#### ステップ5: 「スキャン結果がありません」を削除

**現在のコード (line 198-216)**:
```typescript
) : (
  <Card>
    <Text style={[styles.errorText, {color: colors.textSecondary}]}>
      スキャン結果がありません
    </Text>
    <Button
      title="再スキャン"
      onPress={() => setShowScanner(true)}
      style={styles.button}
      testID="rescan-button-empty"
    />
    <Button
      title="閉じる"
      onPress={handleClose}
      variant="secondary"
      testID="close-button-empty"
    />
  </Card>
)}
```

**修正後**:
```typescript
) : null} {/* ✅ 「スキャン結果がありません」を削除 */}
```

#### ステップ6: スタイルの追加

**現在のスタイル (line 289-295)** の直後に追加:

```typescript
successMessageText: {
  color: '#FFFFFF',
  fontSize: 18,
  fontWeight: '700',
  textAlign: 'center',
},
// ✅ 以下を追加
loadingMessageContainer: {
  position: 'absolute',
  bottom: 100,
  left: 0,
  right: 0,
  alignItems: 'center',
  justifyContent: 'center',
},
loadingMessageBox: {
  backgroundColor: 'rgba(59, 130, 246, 0.9)', // 青色（データ取得中を示す）
  paddingHorizontal: 24,
  paddingVertical: 16,
  borderRadius: 12,
  shadowColor: '#000',
  shadowOffset: {
    width: 0,
    height: 4,
  },
  shadowOpacity: 0.3,
  shadowRadius: 8,
  elevation: 8,
},
loadingMessageText: {
  color: '#FFFFFF',
  fontSize: 18,
  fontWeight: '700',
  textAlign: 'center',
},
```

### 修正2: ScanResultScreen.tsx のダークモード対応

**ファイルパス**: `src/presentation/screens/ScanResultScreen.tsx`

#### ステップ1: imageContainer の背景色修正

**現在のコード (line 321-327)**:
```typescript
imageContainer: {
  alignItems: 'center',
  marginBottom: spacing.lg,
  backgroundColor: '#F5F5F5', // ❌ ハードコード
  borderRadius: 8,
  padding: spacing.md,
},
```

**修正後**: スタイル定義から `backgroundColor` を削除し、コンポーネント内でインライン指定

**ScanResultScreen.tsx の修正 (line 162-169)**:

**現在のコード**:
```typescript
{/* 書影（国立国会図書館形式） */}
<View style={styles.imageContainer}>
  <Image
    source={{uri: `https://ndlsearch.ndl.go.jp/thumbnail/${initialItem.barcode}.jpg`}}
    style={styles.bookImage}
    resizeMode="contain"
    testID="book-image"
  />
</View>
```

**修正後**:
```typescript
{/* 書影（国立国会図書館形式） */}
<View style={[styles.imageContainer, {backgroundColor: colors.card}]}> {/* ✅ テーマカラーを使用 */}
  <Image
    source={{uri: `https://ndlsearch.ndl.go.jp/thumbnail/${initialItem.barcode}.jpg`}}
    style={styles.bookImage}
    resizeMode="contain"
    testID="book-image"
  />
</View>
```

**スタイル定義の修正 (line 321-327)**:
```typescript
imageContainer: {
  alignItems: 'center',
  marginBottom: spacing.lg,
  // ✅ backgroundColor削除（インライン指定に移行）
  borderRadius: 8,
  padding: spacing.md,
},
```

### 代替案: colors.surface を使用する場合

もし `colors.card` が適切でない場合、以下のように `colors.surface` を使用することもできます：

```typescript
<View style={[styles.imageContainer, {backgroundColor: colors.surface || colors.card}]}>
```

または、テーマ定義に新しい色を追加：

**src/config/theme.ts** (または該当ファイル):
```typescript
export const lightTheme = {
  // ...
  imageBackground: '#F5F5F5',
};

export const darkTheme = {
  // ...
  imageBackground: '#2A2A2A', // ダークモード用の暗めの背景
};
```

そして使用：
```typescript
<View style={[styles.imageContainer, {backgroundColor: colors.imageBackground}]}>
```

## 🧪 動作確認方法

### テストシナリオ1: スキャン成功時の表示確認

1. スキャン画面を開く
2. ISBNバーコードをスキャン
3. **期待動作**:
   - ❌ **「スキャン結果がありません」は表示されない**
   - ✅ スキャナー画面がそのまま表示される
   - ✅ 高速通信の場合: ローディングメッセージなしで「✅ Scan Succeed」が表示
   - ✅ 低速通信の場合: 500ms後に「📚 データ取得中...」が表示
   - ✅ 0.5秒間「✅ Scan Succeed」が表示されてから遷移

### テストシナリオ2: ダークモードでの書影表示確認

1. デバイスをダークモードに設定
2. ISBNをスキャンして結果画面に遷移
3. **期待動作**:
   - ❌ **書影コンテナが白っぽくない**
   - ✅ 書影コンテナの背景がダークモードに適した色（暗めのグレー）
   - ✅ 周囲の背景色と調和している

### テストシナリオ3: エラー時の動作確認

1. 無効なバーコードをスキャン
2. **期待動作**:
   - ✅ エラー画面が正しく表示される
   - ✅ 「再スキャン」ボタンで元に戻れる

## ⚠️ 注意事項

### タイマーのクリーンアップ

- `setTimeout` のクリーンアップを確実に実行
- コンポーネントがアンマウントされた場合も考慮

### テーマカラーの選択

- `colors.card`: カードコンポーネントの背景色（推奨）
- `colors.surface`: サーフェス要素の背景色
- `colors.background`: ページ全体の背景色（コントラストが低い可能性あり）

最も適切なのは `colors.card` です。

### パフォーマンス

- `setTimeout` を多用しているため、適切にクリーンアップ
- 不要な再レンダリングを避ける

## 📅 実装スケジュール

1. **ScanScreen.tsx の修正**: 45分
2. **ScanResultScreen.tsx の修正**: 15分
3. **動作確認・デバッグ**: 30分
4. **ダークモード確認**: 15分
5. **コミット・PR作成**: 15分

**合計所要時間**: 約2時間

## ✅ 完了条件

- [ ] ISBNスキャン成功時に「スキャン結果がありません」が表示されない
- [ ] スキャン成功時の待機時間が0.5秒に短縮されている
- [ ] 高速通信時にローディングメッセージが表示されない
- [ ] 低速通信時（500ms以上）に「データ取得中...」が表示される
- [ ] スキャン結果画面の書影コンテナがダークモードに対応している
- [ ] ライトモードでも書影コンテナが適切な背景色で表示される
- [ ] TypeScriptの型チェックが通る
- [ ] ESLint・Prettierを適用
- [ ] 実機でテスト完了
- [ ] コミット・プッシュ完了

## 🔄 今後の改善案

- **連続スキャンモード**: 非ISBNバーコードでもスキャンを継続 (別実装指示書参照)
- **アニメーション**: 成功メッセージのフェードイン/アウト
- **書影の読み込みエラー処理**: 書影が取得できない場合の代替表示

---

## 📊 改善効果の測定

### UX改善指標

| 指標 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|--------|
| ネガティブメッセージ表示 | 100% | 0% | **100%削減** |
| スキャン成功時の待機時間 | 1.5秒 | 0.5秒 | **67%削減** |
| ダークモード対応度 | 70% | 100% | **30%向上** |

---

**作成日**: 2025-01-18
**対象バージョン**: MVP v1.0
**優先度**: **P1（高）** - UXに直接影響する重大な問題

**関連ファイル**:
- `src/presentation/screens/ScanScreen.tsx`
- `src/presentation/screens/ScanResultScreen.tsx`
- `src/config/theme.ts` (必要に応じて)

**関連指示書**:
- `docs/20250118_スキャン成功時UX改善.md`（このmdファイルが統合版）
- `docs/20250118_連続スキャンモード実装.md`（別タスク）
