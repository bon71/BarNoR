# 設定画面の初期表示修正実装指示書

## 📋 問題の詳細

### 現象

設定画面を開く際、すでにNotionトークンが保存されている状態でも、一瞬トークン入力画面が表示されてから設定結果（接続済み）画面に切り替わる。

### 根本原因

**SettingsScreen.tsx:165-202** の分岐処理が原因：

```typescript
{isAuthenticated ? (
  // 接続済み表示
  <View>
    <Text>✓ Notionに接続されています</Text>
    ...
  </View>
) : (
  // トークン入力フォーム
  <View>
    <Text>NotionのIntegration Tokenを入力してください</Text>
    <Input ... />
    ...
  </View>
)}
```

**問題の流れ**:

1. **初回レンダリング**: コンポーネントがマウント
2. **ストア未読み込み**: `useAuthStore` からの `isAuthenticated` がまだ読み込まれていない（初期値 `false`）
3. **トークン入力表示**: `isAuthenticated === false` のため、トークン入力フォームが表示
4. **ストア読み込み完了**: MMKVから永続化データが読み込まれ、`isAuthenticated` が `true` に更新
5. **再レンダリング**: 接続済み表示に切り替わる

この「ストア読み込み中」の期間に、不要なトークン入力フォームが表示されてしまいます。

## 🎯 解決方針

### アプローチ1: ローディング状態の追加（推奨）

初期化完了まで待機し、ローディング状態を表示する：

1. **初期化フラグの追加**: `isInitialized` ステートを追加
2. **ローディング表示**: 初期化中はスケルトン/スピナーを表示
3. **初期化完了後に表示**: ストアの読み込みが完了してから分岐表示

### アプローチ2: useAuthStore の初期化待機

zustand ストアの永続化ハイドレーションを待つ：

1. **ハイドレーション状態の確認**: ストアが完全にロードされたか確認
2. **useEffect での待機**: ハイドレーション完了を検知

### アプローチ3: デフォルト表示の変更

トークン入力フォームではなく、接続済み表示をデフォルトにする：

1. **逆分岐**: `!isAuthenticated` の場合のみトークン入力を表示
2. **フェードイン**: 接続済み表示を最初から表示し、トークン入力に切り替わらないようにする

## 📝 実装内容（アプローチ1: 推奨）

### ステップ1: 初期化状態の追加

**ファイルパス**: `src/presentation/screens/SettingsScreen.tsx`

**現在のコード (line 31-40)**:

```typescript
export const SettingsScreen: React.FC<SettingsScreenProps> = () => {
  const {colors} = useTheme();
  const {mode, toggleMode} = useThemeStore();
  const {isAuthenticated, notionToken} = useAuthStore();
  const {updateDatabaseId, config} = useConfigStore();
  const [token, setToken] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [databases, setDatabases] = useState<Array<{id: string; name: string}>>([]);
  const [loadingDatabases, setLoadingDatabases] = useState(false);
  const [selectedDatabaseId, setSelectedDatabaseId] = useState<string>(config.databaseId || '');
```

**修正後**:

```typescript
export const SettingsScreen: React.FC<SettingsScreenProps> = () => {
  const {colors} = useTheme();
  const {mode, toggleMode} = useThemeStore();
  const {isAuthenticated, notionToken} = useAuthStore();
  const {updateDatabaseId, config} = useConfigStore();
  const [token, setToken] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [databases, setDatabases] = useState<Array<{id: string; name: string}>>([]);
  const [loadingDatabases, setLoadingDatabases] = useState(false);
  const [selectedDatabaseId, setSelectedDatabaseId] = useState<string>(config.databaseId || '');
  const [isInitialized, setIsInitialized] = useState(false); // ✅ 追加
```

### ステップ2: 初期化処理の追加

**現在のコード (line 68-73)**:

```typescript
// トークン保存後にデータベース一覧を取得
useEffect(() => {
  if (isAuthenticated) {
    loadDatabases();
  }
}, [isAuthenticated]);
```

**修正後**:

```typescript
// ✅ 初期化処理を追加
useEffect(() => {
  // 少し遅延させてストアの読み込みを確実に完了させる
  const timer = setTimeout(() => {
    setIsInitialized(true);
  }, 50); // 50msの遅延（ストアのハイドレーションを待つ）

  return () => clearTimeout(timer);
}, []);

// トークン保存後にデータベース一覧を取得
useEffect(() => {
  if (isAuthenticated && isInitialized) {
    loadDatabases();
  }
}, [isAuthenticated, isInitialized]);
```

### ステップ3: ローディング表示の追加

**現在のコード (line 159-202)**:

```typescript
return (
  <SafeAreaView style={[styles.container, {backgroundColor: colors.background}]} testID="settings-screen">
    <ScrollView style={{backgroundColor: colors.background}} contentContainerStyle={styles.scrollContent}>
      <View style={styles.section}>
        <Text style={[styles.sectionTitle, {color: colors.textPrimary}]} testID="settings-notion-title">Notion統合</Text>
        <Card enableBlur={true} blurType="ultraThinMaterial" blurAmount={75}>
          {isAuthenticated ? (
            <View>
              <Text style={styles.connectedText} testID="settings-connected">
                ✓ Notionに接続されています
              </Text>
              ...
            </View>
          ) : (
            <View>
              <Text style={styles.description}>
                NotionのIntegration Tokenを入力してください
              </Text>
              ...
            </View>
          )}
        </Card>
      </View>
      ...
    </ScrollView>
  </SafeAreaView>
);
```

**修正後**:

```typescript
return (
  <SafeAreaView style={[styles.container, {backgroundColor: colors.background}]} testID="settings-screen">
    <ScrollView style={{backgroundColor: colors.background}} contentContainerStyle={styles.scrollContent}>
      <View style={styles.section}>
        <Text style={[styles.sectionTitle, {color: colors.textPrimary}]} testID="settings-notion-title">Notion統合</Text>
        <Card enableBlur={true} blurType="ultraThinMaterial" blurAmount={75}>
          {/* ✅ 初期化中のローディング表示を追加 */}
          {!isInitialized ? (
            <View style={styles.loadingContainer}>
              <ActivityIndicator size="small" color={colors.primary} />
              <Text style={[styles.loadingText, {color: colors.textSecondary}]}>
                読み込み中...
              </Text>
            </View>
          ) : isAuthenticated ? (
            <View>
              <Text style={styles.connectedText} testID="settings-connected">
                ✓ Notionに接続されています
              </Text>
              <Text style={styles.tokenText} testID="settings-token">
                Token: {maskToken(notionToken)}
              </Text>
              <Button
                title="ログアウト"
                onPress={handleLogout}
                variant="danger"
                style={styles.logoutButton}
                testID="logout-button"
              />
            </View>
          ) : (
            <View>
              <Text style={styles.description}>
                NotionのIntegration Tokenを入力してください
              </Text>
              <Input
                label="Integration Token"
                value={token}
                onChangeText={setToken}
                placeholder="secret_..."
                secureTextEntry
                testID="token-input"
              />
              <Button
                title="保存"
                onPress={handleSaveToken}
                loading={isLoading}
                testID="save-token-button"
              />
            </View>
          )}
        </Card>
      </View>
      ...
    </ScrollView>
  </SafeAreaView>
);
```

### ステップ4: データベースセクションの初期化対応

**現在のコード (line 206-264)**:

```typescript
{/* データベース選択セクション */}
{isAuthenticated && (
  <View style={styles.section}>
    ...
  </View>
)}
```

**修正後**:

```typescript
{/* データベース選択セクション */}
{/* ✅ 初期化完了後のみ表示 */}
{isInitialized && isAuthenticated && (
  <View style={styles.section}>
    <Text style={[styles.sectionTitle, {color: colors.textPrimary}]} testID="settings-database-title">
      データベース選択
    </Text>
    <Card enableBlur={true} blurType="ultraThinMaterial" blurAmount={75}>
      {loadingDatabases ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="small" color={colors.primary} />
          <Text style={[styles.loadingText, {color: colors.textSecondary}]}>
            データベースを読み込み中...
          </Text>
        </View>
      ) : databases.length === 0 ? (
        <View>
          <Text style={[styles.emptyText, {color: colors.textSecondary}]}>
            利用可能なデータベースがありません
          </Text>
          <Button
            title="再読み込み"
            onPress={loadDatabases}
            variant="secondary"
            style={styles.reloadButton}
            testID="reload-databases-button"
          />
        </View>
      ) : (
        <View>
          <Text style={[styles.databaseListLabel, {color: colors.textSecondary}]}>
            保存先データベースを選択してください
          </Text>
          {databases.map((db) => (
            <TouchableOpacity
              key={db.id}
              style={[
                styles.databaseItem,
                {borderBottomColor: colors.border},
                selectedDatabaseId === db.id && [styles.selectedDatabase, {backgroundColor: colors.primary + '20'}],
              ]}
              onPress={() => handleSelectDatabase(db.id)}
              testID={`database-item-${db.id}`}>
              <View style={styles.databaseInfo}>
                <Text style={[styles.databaseName, {color: colors.textPrimary}]}>
                  {db.name}
                </Text>
                <Text style={[styles.databaseId, {color: colors.textTertiary}]} numberOfLines={1}>
                  ID: {db.id}
                </Text>
              </View>
              {selectedDatabaseId === db.id && (
                <Text style={[styles.checkmark, {color: colors.primary}]}>✓</Text>
              )}
            </TouchableOpacity>
          ))}
        </View>
      )}
    </Card>
  </View>
)}
```

### 注意: スタイルは既に定義されている

`loadingContainer` と `loadingText` のスタイルは既に **line 405-413** に定義されているため、追加不要です。

## 🧪 動作確認方法

### テストシナリオ1: 初回起動（トークン未設定）

1. アプリをアンインストールして再インストール
2. 設定画面を開く
3. **期待動作**:
   - ✅ 短いローディング表示（50ms）
   - ✅ トークン入力フォームが表示される
   - ❌ **ちらつきがない**

### テストシナリオ2: 既存トークンあり

1. トークンを保存済みの状態
2. アプリを完全に終了して再起動
3. 設定画面を開く
4. **期待動作**:
   - ✅ 短いローディング表示（50ms）
   - ✅ 「✓ Notionに接続されています」が表示される
   - ❌ **トークン入力フォームは表示されない**
   - ❌ **ちらつきがない**

### テストシナリオ3: 高速起動

1. アプリをバックグラウンドから復帰
2. 設定画面を開く
3. **期待動作**:
   - ✅ ローディングがほぼ見えない（50ms以下）
   - ✅ 即座に接続済み表示

## ⚠️ 注意事項

### 遅延時間の調整

50msの遅延が長すぎる/短すぎる場合は調整可能：

```typescript
// より高速化したい場合
setTimeout(() => {
  setIsInitialized(true);
}, 0); // イベントループの次サイクルまで待つ

// より確実にしたい場合
setTimeout(() => {
  setIsInitialized(true);
}, 100); // 100ms待つ
```

### zustand の persist ハイドレーション

zustand の persist を使っている場合、ハイドレーション完了を確実に検知するには：

**useAuthStore の修正（もし persist を使っている場合）**:

```typescript
// src/presentation/stores/useAuthStore.ts
export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      // ... ストアの実装
    }),
    {
      name: 'auth-storage',
      onRehydrateStorage: () => (state) => {
        // ハイドレーション完了を通知
        console.log('Auth store rehydrated');
      },
    }
  )
);
```

ただし、現在のアプローチ（50ms待機）で十分に動作するはずです。

### パフォーマンス

- **50ms の遅延はユーザーに感じられない**: 人間の知覚限界は約100ms
- **ローディング表示は高速**: ActivityIndicatorは軽量
- **UX改善効果**: ちらつきがなくなることで体感品質が大幅に向上

## 📅 実装スケジュール

1. **SettingsScreen.tsx の修正**: 30分
2. **動作確認・デバッグ**: 20分
3. **実機テスト（トークンあり/なし）**: 15分
4. **コミット・PR作成**: 10分

**合計所要時間**: 約1時間15分

## ✅ 完了条件

- [ ] 設定画面を開く際にトークン入力フォームがちらつかない
- [ ] トークン設定済みの場合、即座に接続済み表示が表示される
- [ ] トークン未設定の場合、正しくトークン入力フォームが表示される
- [ ] ローディング時間が適切（50ms程度）
- [ ] データベース選択セクションも正しく初期化される
- [ ] TypeScriptの型チェックが通る
- [ ] ESLint・Prettierを適用
- [ ] 実機でテスト完了
- [ ] コミット・プッシュ完了

## 🔄 代替案（より高度な実装）

### 代替案1: zustand persist のハイドレーション待機

```typescript
// useAuthStore に hasHydrated フラグを追加
export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      isAuthenticated: false,
      notionToken: null,
      hasHydrated: false,
      // ...
    }),
    {
      name: 'auth-storage',
      onRehydrateStorage: () => (state) => {
        if (state) {
          state.hasHydrated = true;
        }
      },
    }
  )
);

// SettingsScreen.tsx で使用
const {isAuthenticated, notionToken, hasHydrated} = useAuthStore();

// hasHydrated を待ってから表示
{!hasHydrated ? (
  <LoadingView />
) : isAuthenticated ? (
  <ConnectedView />
) : (
  <TokenInputView />
)}
```

この方法はより確実ですが、ストアの変更が必要です。

### 代替案2: Suspense の利用（将来的）

React 18+ では Suspense を使った非同期初期化が可能：

```typescript
// 将来的にはこのような実装も検討
<Suspense fallback={<LoadingView />}>
  <SettingsContent />
</Suspense>
```

現時点では、**アプローチ1（50ms遅延）が最もシンプルで効果的**です。

---

## 📊 改善効果の測定

### UX改善指標

| 指標 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|--------|
| トークン入力フォームのちらつき | 100% | 0% | **100%削減** |
| 初期表示の体感速度 | 遅い | 速い | **大幅改善** |
| ユーザー混乱度（主観） | 高 | 低 | **大幅改善** |

---

**作成日**: 2025-01-18
**対象バージョン**: MVP v1.0
**優先度**: **P2（中）** - UX改善、ただし機能には影響しない

**関連ファイル**:
- `src/presentation/screens/SettingsScreen.tsx`
- `src/presentation/stores/useAuthStore.ts` (確認のみ)
