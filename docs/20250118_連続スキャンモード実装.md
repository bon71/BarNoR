# 連続スキャンモード実装指示書

## 📋 概要

バーコードスキャンのUXを改善するため、**連続スキャンモード**を実装します。
非ISBNバーコードをスキャンしてもエラー画面に遷移せず、ISBNが見つかるまで自動的にスキャンを続行します。

## 🎯 目的

- ユーザーがカメラを動かすだけで自動的にISBNバーコードを探せるようにする
- エラー画面を見る頻度を減らし、スムーズなスキャン体験を提供
- 書籍に複数のバーコードがある場合でも、ストレスなくスキャンできるようにする

## 📝 実装内容

### 1. BarcodeScanner.tsxの改修

**ファイルパス**: `src/presentation/components/scanner/BarcodeScanner.tsx`

#### 変更点

1. **状態管理の追加**
   ```typescript
   // スキャン中の検出バーコード情報を管理
   const [detectedBarcode, setDetectedBarcode] = useState<string | null>(null);
   const [barcodeType, setBarcodeType] = useState<'isbn' | 'non-isbn' | null>(null);
   ```

2. **handleCodeScanned の改修**
   - 現在: 最初のバーコードまたはISBNを即座に親コンポーネントに渡す
   - 改善後:
     - ISBNを検出した場合のみ親コンポーネントに渡す
     - 非ISBNの場合は状態を更新し、スキャンを継続

   ```typescript
   const handleCodeScanned = useCallback(
     (codes: Array<{value?: string | null}>) => {
       if (!isActive || !enabled || codes.length === 0) {
         return;
       }

       const validCodes = codes.filter(code => code.value).map(code => code.value!);

       if (validCodes.length === 0) {
         return;
       }

       // ISBN-13/10を優先的に選択
       const isbnCode = validCodes.find(isISBN);

       if (isbnCode) {
         // ISBNが見つかった場合は即座に処理
         setBarcodeType('isbn');
         setDetectedBarcode(isbnCode);
         setIsActive(false);
         onBarcodeScanned(isbnCode);
       } else {
         // 非ISBNの場合は状態のみ更新してスキャン継続
         setBarcodeType('non-isbn');
         setDetectedBarcode(validCodes[0]);
         // isActiveはtrueのまま維持してスキャン継続
       }
     },
     [isActive, enabled, onBarcodeScanned],
   );
   ```

3. **リアルタイムフィードバックUIの追加**

   スキャンエリアの下に、現在の検出状態を表示：

   ```typescript
   {/* スキャン状態フィードバック */}
   {detectedBarcode && barcodeType === 'non-isbn' && (
     <View style={styles.feedbackContainer}>
       <View style={styles.feedbackBox}>
         <Text style={styles.feedbackText}>
           📦 {detectedBarcode.substring(0, 13)}...
         </Text>
         <Text style={styles.feedbackHint}>
           ISBNを探しています...
         </Text>
       </View>
     </View>
   )}

   {detectedBarcode && barcodeType === 'isbn' && (
     <View style={styles.feedbackContainer}>
       <View style={[styles.feedbackBox, styles.feedbackBoxSuccess]}>
         <Text style={styles.feedbackTextSuccess}>
           ✅ ISBN検出！
         </Text>
       </View>
     </View>
   )}
   ```

4. **スタイルの追加**

   ```typescript
   feedbackContainer: {
     position: 'absolute',
     bottom: 120,
     left: 0,
     right: 0,
     alignItems: 'center',
     justifyContent: 'center',
   },
   feedbackBox: {
     backgroundColor: 'rgba(0,0,0,0.7)',
     paddingHorizontal: 20,
     paddingVertical: 12,
     borderRadius: 8,
     borderWidth: 1,
     borderColor: 'rgba(255,255,255,0.3)',
   },
   feedbackBoxSuccess: {
     backgroundColor: 'rgba(16, 185, 129, 0.9)',
     borderColor: 'rgba(255,255,255,0.5)',
   },
   feedbackText: {
     color: colors.white,
     fontSize: typography.fontSize.sm,
     fontWeight: '600',
     textAlign: 'center',
   },
   feedbackHint: {
     color: 'rgba(255,255,255,0.7)',
     fontSize: typography.fontSize.xs,
     marginTop: 4,
     textAlign: 'center',
   },
   feedbackTextSuccess: {
     color: colors.white,
     fontSize: typography.fontSize.md,
     fontWeight: '700',
     textAlign: 'center',
   },
   ```

### 2. ScanScreen.tsxの改修（任意）

**ファイルパス**: `src/presentation/screens/ScanScreen.tsx`

#### 変更点（オプション）

エラーハンドリングの改善（ISBNが見つからない場合のタイムアウト処理など）は後続タスクとして検討。
今回の実装では、BarcodeScanner側の改修のみで連続スキャンモードを実現します。

### 3. barcodeValidation.tsの確認

**ファイルパス**: `src/utils/barcodeValidation.ts`

既存の `isISBN`, `isISBN13`, `isISBN10` 関数をそのまま使用します。
変更は不要です。

## 🧪 動作確認方法

### テストシナリオ

1. **非ISBNバーコードをスキャン**
   - スキャン画面を開く
   - 書籍の裏表紙にある価格バーコード（JANコード）をスキャン
   - **期待動作**:
     - エラー画面に遷移しない
     - 画面下部に「📦 491234567890... / ISBNを探しています...」と表示
     - スキャンが継続される

2. **ISBNバーコードをスキャン**
   - 同じ書籍のISBNバーコード（978または979で始まる）をスキャン
   - **期待動作**:
     - 「✅ ISBN検出！」と緑色の背景で表示
     - バイブレーション発生
     - 1.5秒後にScanResultScreenに遷移

3. **連続スキャン**
   - カメラを動かして複数のバーコードを次々にスキャン
   - **期待動作**:
     - 非ISBNバーコードは検出表示のみでスキャン継続
     - ISBNバーコードを検出した瞬間に処理開始

## ⚠️ 注意事項

### 既存機能への影響

- **ScanScreen.tsx**: `handleBarcodeScanned` の呼び出しタイミングは変わらない（ISBNが見つかった場合のみ呼ばれる）
- **ScanViewModel.ts**: 変更不要
- **既存のエラーハンドリング**: そのまま維持

### パフォーマンス考慮

- `handleCodeScanned` は高頻度で呼ばれるため、重い処理は避ける
- 状態更新は最小限に抑える（検出されたバーコードが変わった場合のみ更新）

### アクセシビリティ

- 視覚的フィードバックだけでなく、音声フィードバックも検討（今後の改善）
- ハプティックフィードバック（バイブレーション）はISBN検出時のみ

## 📅 実装スケジュール

1. **BarcodeScanner.tsxの改修**: 30分
2. **動作確認・デバッグ**: 30分
3. **実機テスト**: 15分
4. **コミット・PR作成**: 15分

**合計所要時間**: 約1.5時間

## 🔄 今後の改善案

- **タイムアウト機能**: 一定時間（例：10秒）ISBNが見つからない場合にヒントを表示
- **バーコード種別の詳細表示**: 「EAN-13検出」「QRコード検出」など具体的な種別を表示
- **音声ガイダンス**: 「ISBNバーコードを探しています」など音声で案内
- **手動モード切替**: 連続スキャンモードと従来の単発スキャンモードを切り替え可能に

## ✅ 完了条件

- [ ] BarcodeScanner.tsxに連続スキャンロジックを実装
- [ ] リアルタイムフィードバックUIを追加
- [ ] 実機でテストし、非ISBNバーコードでエラー画面に遷移しないことを確認
- [ ] ISBNバーコードをスキャンすると正常に次画面に遷移することを確認
- [ ] TypeScriptの型チェックが通ることを確認
- [ ] ESLint・Prettierを適用
- [ ] コミット・プッシュ完了

---

**作成日**: 2025-01-18
**対象バージョン**: MVP v1.0
**関連ファイル**:
- `src/presentation/components/scanner/BarcodeScanner.tsx`
- `src/utils/barcodeValidation.ts`
